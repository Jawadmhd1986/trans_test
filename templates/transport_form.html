<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transportation Quotation</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <img class="dsv-logo" src="{{ url_for('static', filename='dsv_logo.png') }}" alt="DSV" />

  <section class="quote-section">
    <div class="quote-card">
      <h1>Transportation Quotation</h1>

      <!-- global cargo type -->
      <label for="cargo_type">Cargo Type</label>
      <select id="cargo_type">
        <option value="general" selected>General Cargo</option>
        <option value="chemical">Chemical Load</option>
      </select>

      <!-- Requests wrapper: we’ll add blocks inside -->
      <div id="requests"></div>

      <button id="btn-generate" class="btn-generate">Generate</button>
    </div>
  </section>

  <!-- (Optional) your chatbot button/UI can stay as-is via chatbot.js -->

  <script>
    // ---------- helpers ----------
    const $  = (q, r=document) => r.querySelector(q);
    const $$ = (q, r=document) => Array.from(r.querySelectorAll(q));

    const ORIGINS   = {{ origins|tojson }};
    const CITIES    = {{ destinations|tojson }};
    const TRUCKS_ALL = {{ truck_types|tojson }}; // union of all display labels

    // ---------- UI Makers ----------
    function makeSelect(options, placeholder){
      const s = document.createElement('select');
      const ph = document.createElement('option');
      ph.value = ""; ph.textContent = placeholder; ph.disabled = true; ph.selected = true;
      s.appendChild(ph);
      options.forEach(v=>{
        const o = document.createElement('option');
        o.value = v; o.textContent = v; s.appendChild(o);
      });
      return s;
    }

    function makeTripSelector(){
      const wrap = document.createElement('div');
      wrap.className = 'trip-options';
      const name = 'trip_'+Date.now()+'_'+Math.random().toString(36).slice(2,7);

      const r1 = Object.assign(document.createElement('input'), {type:'radio', name, value:'one_way', id:'ow_'+name, checked:true});
      const l1 = Object.assign(document.createElement('label'), {htmlFor:r1.id});
      l1.textContent = 'One Way'; l1.classList.add('selected');

      const r2 = Object.assign(document.createElement('input'), {type:'radio', name, value:'back_load', id:'bl_'+name});
      const l2 = Object.assign(document.createElement('label'), {htmlFor:r2.id});
      l2.textContent = 'Back Load';

      function refresh(){
        l1.classList.toggle('selected', r1.checked);
        l2.classList.toggle('selected', r2.checked);
      }
      r1.addEventListener('change', refresh);
      r2.addEventListener('change', refresh);

      // Robust label click (even if something overlays)
      wrap.addEventListener('click', (e)=>{
        if(e.target.tagName === 'LABEL'){
          const id = e.target.getAttribute('for');
          const inp = wrap.querySelector('#'+CSS.escape(id));
          if(inp){ inp.checked = true; refresh(); }
        }
      });

      wrap.append(r1,l1,r2,l2);
      return wrap;
    }

    function makeTruckRow(){
      const row = document.createElement('div');
      row.className = 'truck-type-row';

      const selWrap = document.createElement('div');
      selWrap.className = 'select-wrapper';
      const lbl1 = document.createElement('label'); lbl1.textContent = 'Type';
      const sel = makeSelect(TRUCKS_ALL, '— Select Truck Type —');
      selWrap.append(lbl1, sel);

      const qtyWrap = document.createElement('div');
      qtyWrap.className = 'qty-wrapper';
      const lbl2 = document.createElement('label'); lbl2.textContent = 'QTY';
      const qty = Object.assign(document.createElement('input'), {type:'number', min:'1', step:'1', value:'1'});
      qtyWrap.append(lbl2, qty);

      const btnClear = document.createElement('button');
      btnClear.type = 'button';
      btnClear.className = 'btn-remove';
      btnClear.textContent = 'Clear';
      btnClear.addEventListener('click', ()=> row.remove());

      row.append(selWrap, qtyWrap, btnClear);
      return row;
    }

    function makeRequestBlock({withRemove=false}={}){
      const block = document.createElement('div');
      block.className = 'request-block';

      // Row: From / To
      const rowFT = document.createElement('div');
      rowFT.className = 'form-row';
      const g1 = document.createElement('div'); g1.className = 'form-group';
      const g2 = document.createElement('div'); g2.className = 'form-group';

      const lFrom = document.createElement('label'); lFrom.textContent = 'From';
      const sFrom = makeSelect(ORIGINS, '— Select Pickup —');

      const lTo = document.createElement('label'); lTo.textContent = 'To';
      const sTo = makeSelect(CITIES, '— Select City —');

      g1.append(lFrom, sFrom); g2.append(lTo, sTo);
      rowFT.append(g1, g2);

      // Trip card box
      const tripCard = document.createElement('div');
      tripCard.className = 'trip-card';

      const tLabel = document.createElement('label'); tLabel.textContent = 'Trip Type';
      const tripSel = makeTripSelector();
      tripCard.append(tLabel, tripSel);

      // trucks container + first row
      const trucksWrap = document.createElement('div');
      trucksWrap.className = 'trucks';
      trucksWrap.append( makeTruckRow() );

      const actions = document.createElement('div');
      actions.className = 'request-actions';

      const btnAddTruck = document.createElement('button');
      btnAddTruck.type = 'button';
      btnAddTruck.className = 'btn-add';
      btnAddTruck.textContent = '+ Add Truck Type';
      btnAddTruck.addEventListener('click', ()=> trucksWrap.append( makeTruckRow() ));

      const btnAddFT = document.createElement('button');
      btnAddFT.type = 'button';
      btnAddFT.className = 'btn-add-ft';
      btnAddFT.textContent = '+ Add From/To';
      btnAddFT.addEventListener('click', ()=> addRequestBlock(true));

      const btnRemoveBlock = document.createElement('button');
      btnRemoveBlock.type = 'button';
      btnRemoveBlock.className = 'btn-remove btn-remove-block';
      btnRemoveBlock.textContent = 'Remove From/To';
      btnRemoveBlock.style.marginLeft = 'auto';
      btnRemoveBlock.addEventListener('click', ()=> block.remove());

      actions.append(btnAddTruck, btnAddFT);
      if (withRemove) actions.append(btnRemoveBlock);

      tripCard.append(trucksWrap, actions);
      block.append(rowFT, tripCard);
      return block;
    }

    function addRequestBlock(withRemove){
      $('#requests').appendChild(makeRequestBlock({withRemove}));
    }

    // ---------- boot ----------
    addRequestBlock(false); // first block (no remove)
    // main trip radios styling safety (if you later put a "main" set above blocks)
    // handled per-block by makeTripSelector()

    // ---------- submit ----------
    $('#btn-generate').addEventListener('click', async ()=>{
      const cargo_type = $('#cargo_type').value;
      const requests = [];
      $$('#requests .request-block').forEach((b)=>{
        const origin = $('select', $('.form-group', b));
        const dest   = $$('.form-group select', b)[1];
        const trip   = $('.trip-options input[type=radio]:checked', b);
        const trucks = [];

        $$('.trucks .truck-type-row', b).forEach((r)=>{
          const label = $('select', r).value || '';
          const qty   = $('input[type=number]', r).value || '0';
          if(label && Number(qty) > 0){
            trucks.push({label, qty, trip_kind: (trip ? trip.value : 'one_way')});
          }
        });

        if(origin && dest){
          requests.push({
            origin: origin.value || '',
            destination: dest.value || '',
            main_trip: (trip ? trip.value : 'one_way'),
            trucks
          });
        }
      });

      if(!requests.length){ alert('Please fill at least one From/To and a truck.'); return; }

      try{
        const res = await fetch('/generate_transport_multi', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ cargo_type, requests })
        });
        if(!res.ok){ const err = await res.json().catch(()=>({error:'Server error'})); throw new Error(err.error||'Server error'); }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'Transport_Quotation_Multi.docx';
        document.body.appendChild(a); a.click();
        a.remove(); URL.revokeObjectURL(url);
      }catch(e){
        alert(e.message || 'Failed to generate document.');
      }
    });
  </script>
</body>
</html>
